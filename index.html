<!DOCTYPE html>
<html>
  <head>
    <title>STL</title>
    <script src="https://threejs.org/build/three.min.js"></script>
    <script src="https://threejs.org/examples/js/loaders/STLLoader.js"></script>
    <script src="https://threejs.org/examples/js/controls/OrbitControls.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <style>
      body {
        overflow: hidden;
        margin: 0;
        position: relative;
      }
      .colorpick{
        display: flex;
        align-items: flex-start;
        gap :10px;
        flex-direction: column;
        position: absolute;
        width: 100%;
      }
      .colorClass {
        width: 100px;
        height: 30px;
        margin: 10px;
        z-index: 999;
        position: relative;
      }
      .first{
        background-color: #f0f0f0;
      }
      .sec{
        background-color: #a14aa1;
      }
      .third{
        background-color: #1e2ce2;

      }
    </style>
  </head>
  <body>
    <input type="file" id="loadStl" accept=".stl" /><br />
    <input id="resultField" /><br /><br />
    <div class="colorpick">
      <div class="colorClass first" onclick='changeMaterial("#f0f0f0")' ></div>
      <div class="colorClass sec" onclick='changeMaterial("#a14aa1")' ></div>
      <div class="colorClass third" onclick='changeMaterial("#1e2ce2")' ></div>
    </div>
    <script>

      var newColor = '0xf0f0f';
      var mesh;
      var scene = new THREE.Scene();
      var camera = new THREE.PerspectiveCamera(
        60,
        window.innerWidth / window.innerHeight,
        0.01,
        1000
      );
      camera.position.setScalar(100);
      var renderer = new THREE.WebGLRenderer();
      renderer.setClearColor(0x777777);
      renderer.setSize(window.innerWidth, window.innerHeight);
      document.body.appendChild(renderer.domElement);
      const light = new THREE.AmbientLight( 0x404040 ); // soft white light
      scene.add( light );

      const NewSpotlight = new THREE.SpotLight(0x0dfe6e9, .2);
      NewSpotlight.castShadow = true;
      NewSpotlight.position.set(-50, -100, 50);
      scene.add(NewSpotlight);

      spotlight = new THREE.SpotLight(0x0dfe6e9, .3);
      spotlight.castShadow = true;
      spotlight.position.set(100, 100, 20);
      scene.add(spotlight);

      var controls = new THREE.OrbitControls(camera, renderer.domElement);

      const loadStl = document.querySelector("#loadStl");
      loadStl.addEventListener("change", function () {
        const reader = new FileReader();
        reader.addEventListener("load", () => {
          var loader = new THREE.STLLoader();
          loader.load(reader.result, function (geometry) {
             mesh = new THREE.Mesh(
              geometry,
              new THREE.MeshPhongMaterial({
                shininess: 100,
                // map: new THREE.TextureLoader().load('https://threejs.org/examples/textures/water/Water_2_M_Normal.jpg'),
                // bumpMap: new THREE.TextureLoader().load('https://threejs.org/examples/textures/water.jpg'),
                wireframe: false,
                specular: 0x636e72, 
                flatShading: false,
                color: 0xf0f0f0
              })
              // new THREE.MeshBasicMaterial({
              //   color: 0xfdf0f0
              // })
            );
            // mesh.material.rotation.set(-Math.PI / 2, 0, 0);
            mesh.scale.setScalar(1);
            scene.add(mesh);
            document.querySelector("#resultField").value =
              "stl volume is " + getVolume(geometry);
          });
        });
        reader.readAsDataURL(this.files[0]);
      });

      // check with known volume:
      var hollowCylinderGeom = new THREE.LatheBufferGeometry(
        [
          new THREE.Vector2(1, 0),
          new THREE.Vector2(2, 0),
          new THREE.Vector2(2, 2),
          new THREE.Vector2(1, 2),
          new THREE.Vector2(1, 0),
        ],
        90
      ).toNonIndexed();
      console.log(
        "pre-computed volume of a hollow cylinder (PI * (R^2 - r^2) * h): " +
          Math.PI * (Math.pow(2, 2) - Math.pow(1, 2)) * 2
      );
      console.log(
        "computed volume of a hollow cylinder: " + getVolume(hollowCylinderGeom)
      );

      function changeMaterial(color){
        var rgbcolor = hexToRgbA(color);
        mesh.material.color.set(rgbcolor);
        // console.log('aaaaaa',mesh.material.color)
      }

      const hexToRgbA = (hex) =>{
        var c;
        if(/^#([A-Fa-f0-9]{3}){1,2}$/.test(hex)){
            c= hex.substring(1).split('');
            if(c.length== 3){
                c= [c[0], c[0], c[1], c[1], c[2], c[2]];
            }
            c= '0x'+c.join('');
            return 'rgba('+[(c>>16)&255, (c>>8)&255, c&255].join(',')+',1)';
        }
        throw new Error('Bad Hex');
      }

      function getVolume(geometry) {
        let position = geometry.attributes.position;
        let faces = position.count / 3;
        let sum = 0;
        let p1 = new THREE.Vector3(),
          p2 = new THREE.Vector3(),
          p3 = new THREE.Vector3();
        for (let i = 0; i < faces; i++) {
          p1.fromBufferAttribute(position, i * 3 + 0);
          p2.fromBufferAttribute(position, i * 3 + 1);
          p3.fromBufferAttribute(position, i * 3 + 2);
          sum += signedVolumeOfTriangle(p1, p2, p3);
        }
        return sum;
      }

      function getRandomColor() {
        var letters = "0123456789ABCDEF";
        var color = "#";
        for (var i = 0; i < 6; i++) {
          color += letters[Math.floor(Math.random() * 16)];
        }
        return color;
      }

      function setRandomColor() {
        var color = getRandomColor();
        $("#colorpad1").css("background-color", color);
        document.querySelector("#colorValue1").value =
          "Random color : " + color;
        newColor = color;
      }

      function signedVolumeOfTriangle(p1, p2, p3) {
        return p1.dot(p2.cross(p3)) / 6.0;
      }

      renderer.setAnimationLoop(() => {
        renderer.render(scene, camera);
      });
    </script>
  </body>
</html>
